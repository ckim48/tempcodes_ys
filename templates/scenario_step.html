{% extends "base.html" %}
{% block content %}

<style>
:root {
  --ink:#2b2b2b; --muted:#6b6b6b; --primary:#574545; --secondary:#ab8e8e;
  --bg:#fdfcfc; --surface:#ffffff; --edge:#e8e3e3; --shadow:0 8px 24px rgba(87,69,69,0.08);
}
body { background:linear-gradient(180deg,#faf9f9 0%, #f5f2f2 100%); font-family:'Inter', system-ui, sans-serif; color:var(--ink); }

/* Layout / Head */
.page { max-width:960px; margin:0 auto; padding:1.5rem; }
.page-head{ display:flex; justify-content:space-between; align-items:end; flex-wrap:wrap; gap:1rem; margin-bottom:1.25rem; }
.title-wrap h1{ font-weight:800; color:var(--primary); margin:0; letter-spacing:.15px; }
.title-wrap p{ color:var(--muted); margin:.3rem 0 0; font-size:.95rem; }
.stepper{ width:250px; text-align:right; }
.stepper .count{ color:var(--muted); font-weight:600; }
.progress{ height:8px; background:#e8e3e3; border-radius:999px; overflow:hidden; margin-top:.3rem; }
.progress-bar{ background:var(--secondary); }

/* Hero image */
.hero {
  margin-bottom: 1rem;
}
.hero-img {
  background: var(--surface);
  border: 1px solid var(--edge);
  border-radius: 16px;
  box-shadow: var(--shadow);
  overflow: hidden;
}
.hero-img img {
  display:block; width:100%; height:auto;
}

/* Drawer */
.drawer{ background:var(--surface); border:1px solid var(--edge); border-radius:16px; box-shadow:var(--shadow); margin-bottom:1.2rem; transition:all .25s ease; }
.drawer-header{ display:flex; justify-content:space-between; align-items:center; padding:.9rem 1.1rem; cursor:pointer; }
.drawer-header h4{ font-weight:700; margin:0; color:var(--primary); font-size:1rem; }
.drawer-body{ display:none; border-top:1px solid var(--edge); padding:1rem 1.3rem; color:var(--muted); line-height:1.6; }
.drawer.open .drawer-body{ display:block; }

/* Card / Content */
.card{ background:var(--surface); border:1px solid var(--edge); border-radius:16px; box-shadow:var(--shadow); }
.card-body{ padding:1.5rem; }

/* Situation & Question */
.situation h2{ font-size:1.1rem; color:var(--primary); font-weight:700; margin-bottom:.5rem; }
.situation p{ color:var(--muted); margin:0 0 1rem; line-height:1.6; }
.q-chip{ display:inline-block; background:#f8f3f3; color:var(--primary); padding:.25rem .6rem; border-radius:999px; font-weight:700; font-size:.75rem; text-transform:uppercase; letter-spacing:.25px; border:1px solid #e6dcdc; }

/* Options */
.options{ display:flex; flex-direction:column; gap:.9rem; margin-top:1rem; }
.option{
  display:flex; align-items:flex-start; gap:.8rem;
  border:1px solid var(--edge); background:#fff; border-radius:14px; padding:1rem 1.1rem;
  transition:all .18s ease; position:relative;
}
.option:hover{ transform:translateY(-2px); box-shadow:0 10px 20px rgba(87,69,69,0.12); }
.option:has(input:checked){ border-color:var(--secondary);
  background:linear-gradient(90deg, #fdf9f9 0%, #fff3f3 100%); box-shadow:0 0 0 3px #f1e5e5; }
.option:has(input:checked)::before{
  content:""; position:absolute; left:0; top:0; bottom:0; width:6px; border-radius:14px 0 0 14px; background:var(--secondary);
}
.option input{
  appearance:none; -webkit-appearance:none; width:22px; height:22px; margin-top:.25rem;
  border:2px solid #c8bfbf; border-radius:50%; cursor:pointer; transition:all .15s ease; box-shadow:0 0 0 3px transparent;
}
.option input:checked{ border-color:var(--secondary); box-shadow:0 0 0 5px rgba(171,142,142,0.35);
  background:radial-gradient(circle at center, var(--secondary) 45%, transparent 46%); }
.o-main{ flex:1; }
.o-title{ font-weight:700; color:var(--primary); margin:0; font-size:1rem; }
.o-hint{ color:var(--muted); margin:.25rem 0 0; font-size:.95rem; }

/* Action */
.actions{ text-align:right; margin-top:1.4rem; }
.btn-custom{
  background:var(--primary); color:#fff; border:none; border-radius:10px; padding:.7rem 1.3rem;
  font-weight:700; font-size:.95rem; letter-spacing:.3px; transition:all .2s ease;
}
.btn-custom:hover{ background:var(--secondary); transform:translateY(-1px); box-shadow:0 6px 18px rgba(171,142,142,0.35); }

/* Modal theme */
.modal-content{ border-radius:16px; border:1px solid var(--edge); }
.modal-header{ border-bottom:1px solid var(--edge); }
.modal-footer{ border-top:1px solid var(--edge); }
.form-check-label{ color:var(--ink); }
.form-textarea{ width:100%; border:1px solid var(--edge); border-radius:12px; padding:.6rem .8rem; min-height:110px; }

/* Validation helpers */
.form-textarea.is-invalid,
.form-check-input.is-invalid { border-color:#dc3545 !important; box-shadow:0 0 0 .2rem rgba(220,53,69,.15) !important; }
.invalid-hint{ color:#dc3545; font-size:.9rem; margin-top:.35rem; }

/* Loading overlay */
.loading-overlay {
  position: fixed; inset: 0; background: rgba(253,252,252,0.85);
  display: none; align-items: center; justify-content: center; z-index: 2000;
}
.loading-overlay.show { display: flex; }
.loading-card {
  background: var(--surface); border:1px solid var(--edge); border-radius:16px;
  box-shadow:var(--shadow); padding:1.25rem 1.5rem; text-align:center; max-width: 360px;
}
.loading-card p { margin: .75rem 0 0; color: var(--muted); }

@media (max-width:768px){ .stepper{ width:100%; text-align:left; } }
</style>

<div class="page">
  <div class="page-head">
    <div class="title-wrap">
      <h1>{{ scenario_title }}</h1>
      <p>One ethical choice at a time. Reflect carefully, then decide.</p>
    </div>
    <div class="stepper">
      <div class="count">Step {{ step_index }} / {{ total_steps }}</div>
      <div class="progress">
        <div class="progress-bar" style="width: {{ (step_index / total_steps * 100) | round(0) }}%"></div>
      </div>
    </div>
  </div>

  {% if cover_image %}
  <div class="hero">
    <div class="hero-img">
      <img class="img-fluid d-block mx-auto" src="{{ url_for('static', filename=cover_image) }}" alt="Scenario cover image" style="width:60%;">
    </div>
  </div>
  {% endif %}

  <div class="drawer" id="drawer">
    <div class="drawer-header" id="drawerBtn">
      <h4>Story & Recap</h4>
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M7 10l5 5 5-5" stroke="#574545" stroke-width="2" stroke-linecap="round"/></svg>
    </div>
    <div class="drawer-body">
      <h5 style="margin-top:0;">Story so far</h5>
      {% if story_so_far %}<p>{{ story_so_far }}</p>{% else %}
        <p>Your stitched narrative will appear here after your first choice.</p>
      {% endif %}
      {% if prev_recap %}
      <hr>
      <p><strong>Previous step:</strong> {{ prev_recap.step_title }}</p>
      <p><strong>Decision:</strong> {{ prev_recap.chosen_label }}</p>
      <p><strong>Consequence:</strong> {{ prev_recap.chosen_consequence }}</p>
      {% endif %}
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <div class="situation">
        <h2>{{ step.title }}</h2>
        <p>{{ situation_text }}</p>
        <div class="q-chip">Decision</div>
        <p style="font-weight:700; color:var(--primary); margin-top:.4rem;">
          {{ question_text or "What will you do?" }}
        </p>
      </div>

      <form id="decisionForm" method="post">
        <!-- hidden fields for modal payloads -->
        <input type="hidden" name="pre_kind" id="pre_kind">
        <input type="hidden" name="pre_question" id="pre_question">
        <input type="hidden" name="pre_text" id="pre_text">
        <input type="hidden" name="pre_choice_value" id="pre_choice_value">
        <input type="hidden" name="pre_choice_label" id="pre_choice_label">

        <input type="hidden" name="post_kind" id="post_kind">
        <input type="hidden" name="post_question" id="post_question">
        <input type="hidden" name="post_text" id="post_text">
        <input type="hidden" name="post_choice_value" id="post_choice_value">
        <input type="hidden" name="post_choice_label" id="post_choice_label">

        <fieldset>
          <legend class="visually-hidden">{{ question_text }}</legend>
          <div class="options">
            {% for opt in step.options %}
            <label class="option">
              <input type="radio" name="choice" value="{{ opt.value }}" {% if selected == opt.value %}checked{% endif %}>
              <div class="o-main">
                <p class="o-title">{{ opt.label }}</p>
                <p class="o-hint">{{ opt.consequence }}</p>
              </div>
            </label>
            {% endfor %}
          </div>
        </fieldset>

        <div class="actions">
          <button class="btn-custom" id="continueBtn" type="button">
            {{ 'Finish' if is_last else 'Continue' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Loading overlay -->
<div id="loadingOverlay" class="loading-overlay" aria-hidden="true">
  <div class="loading-card">
    <div class="spinner-border" role="status" aria-label="Loading"></div>
    <p id="loadingMsg">Finalizing your result…</p>
  </div>
</div>

<!-- ===== Pre-Survey Modal (required) ===== -->
<div class="modal fade" id="preModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog"><div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title">Quick check (before you decide)</h5>
      <button type="button" class="btn-close" aria-label="Close"></button>
    </div>
    <div class="modal-body">
      {% if pre_survey %}
        <p class="mb-2"><strong>{{ pre_survey.question }}</strong></p>
        {% if pre_survey.kind == 'mcq' %}
          <div class="vstack gap-2" id="pre_mcq_group">
            {% for label, val in pre_survey.choices %}
              <div class="form-check">
                <input class="form-check-input" type="radio" name="pre_mcq" id="pre_{{ loop.index }}" value="{{ val }}" data-label="{{ label }}">
                <label class="form-check-label" for="pre_{{ loop.index }}">{{ label }}</label>
              </div>
            {% endfor %}
          </div>
          <div id="preError" class="invalid-hint d-none">Please choose an option.</div>
        {% else %}
          <textarea class="form-textarea" id="pre_textarea" placeholder="Write a short thought (≥ 20 characters)..."></textarea>
          <div id="preError" class="invalid-hint d-none">Please write at least 20 characters.</div>
        {% endif %}
      {% else %}
        <p class="text-muted">No pre-survey this step.</p>
      {% endif %}
    </div>
    <div class="modal-footer">
      <!-- programmatic close after validation -->
      <button type="button" id="preConfirm" class="btn btn-dark">Save</button>
    </div>
  </div></div>
</div>

<!-- ===== Post-Reflection Modal (required) ===== -->
<div class="modal fade" id="postModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog"><div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title">Quick reflection (after your choice)</h5>
      <button type="button" class="btn-close" aria-label="Close"></button>
    </div>
    <div class="modal-body">
      {% if post_survey %}
        <p class="mb-2"><strong>{{ post_survey.question }}</strong></p>
        {% if post_survey.kind == 'mcq' %}
          <div class="vstack gap-2" id="post_mcq_group">
            {% for label, val in post_survey.choices %}
              <div class="form-check">
                <input class="form-check-input" type="radio" name="post_mcq" id="post_{{ loop.index }}" value="{{ val }}" data-label="{{ label }}">
                <label class="form-check-label" for="post_{{ loop.index }}">{{ label }}</label>
              </div>
            {% endfor %}
          </div>
          <div id="postError" class="invalid-hint d-none">Please choose an option.</div>
        {% else %}
          <textarea class="form-textarea" id="post_textarea" placeholder="Write a short reflection (≥ 20 characters)..."></textarea>
          <div id="postError" class="invalid-hint d-none">Please write at least 20 characters.</div>
        {% endif %}
      {% else %}
        <p class="text-muted">No post-reflection this step.</p>
      {% endif %}
    </div>
    <div class="modal-footer">
      <!-- programmatic close after validation -->
      <button type="button" id="postConfirm" class="btn btn-dark">
        {{ 'Save & Finish' if is_last else 'Save & Continue' }}
      </button>
    </div>
  </div></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
const drawer = document.getElementById('drawer');
const btn = document.getElementById('drawerBtn');
if(btn){
  btn.addEventListener('click',()=>{
    drawer.classList.toggle('open');
    const path = btn.querySelector('path');
    path.setAttribute('d', drawer.classList.contains('open') ? 'M7 14l5-5 5 5' : 'M7 10l5 5 5-5');
  });
}

const hasPre = {{ 'true' if pre_survey else 'false' }};
const hasPost = {{ 'true' if post_survey else 'false' }};
const preKind = "{{ pre_survey.kind if pre_survey else '' }}";
const postKind = "{{ post_survey.kind if post_survey else '' }}";
const preQuestion = "{{ pre_survey.question|e if pre_survey else '' }}";
const postQuestion = "{{ post_survey.question|e if post_survey else '' }}";
const isLast = {{ 'true' if is_last else 'false' }};
const isGpt  = "{{ scenario_id }}" === "G";

const df = document.getElementById('decisionForm');
const continueBtn = document.getElementById('continueBtn');

// ---------- Helpers ----------
function showError(id){ const el = document.getElementById(id); if(el) el.classList.remove('d-none'); }
function hideError(id){ const el = document.getElementById(id); if(el) el.classList.add('d-none'); }

function validatePre(){
  if(!hasPre) return true;
  hideError('preError');

  if(preKind === 'mcq'){
    const chosen = document.querySelector('input[name="pre_mcq"]:checked');
    document.querySelectorAll('input[name="pre_mcq"]').forEach(r=>r.classList.remove('is-invalid'));
    if(!chosen){
      const first = document.querySelector('input[name="pre_mcq"]');
      if(first) first.classList.add('is-invalid');
      showError('preError');
      return false;
    }
    return true;
  }else if(preKind === 'text'){
    const ta = document.getElementById('pre_textarea');
    ta?.classList.remove('is-invalid');
    const val = (ta?.value || '').trim();
    if(val.length < 20){
      ta?.classList.add('is-invalid');
      showError('preError');
      return false;
    }
    return true;
  }
  return true;
}

function validatePost(){
  if(!hasPost) return true;
  hideError('postError');

  if(postKind === 'mcq'){
    const chosen = document.querySelector('input[name="post_mcq"]:checked');
    document.querySelectorAll('input[name="post_mcq"]').forEach(r=>r.classList.remove('is-invalid'));
    if(!chosen){
      const first = document.querySelector('input[name="post_mcq"]');
      if(first) first.classList.add('is-invalid');
      showError('postError');
      return false;
    }
    return true;
  }else if(postKind === 'text'){
    const ta = document.getElementById('post_textarea');
    ta?.classList.remove('is-invalid');
    const val = (ta?.value || '').trim();
    if(val.length < 20){
      ta?.classList.add('is-invalid');
      showError('postError');
      return false;
    }
    return true;
  }
  return true;
}

// Hidden field fillers
function fillHiddenPre(){
  document.getElementById('pre_kind').value = preKind || '';
  document.getElementById('pre_question').value = preQuestion || '';
  if(preKind === 'text'){
    document.getElementById('pre_text').value = (document.getElementById('pre_textarea')?.value || '').trim();
  }else if(preKind === 'mcq'){
    const chosen = document.querySelector('input[name="pre_mcq"]:checked');
    if(chosen){
      document.getElementById('pre_choice_value').value = chosen.value;
      document.getElementById('pre_choice_label').value = chosen.getAttribute('data-label') || '';
    }
  }
}

function fillHiddenPost(){
  document.getElementById('post_kind').value = postKind || '';
  document.getElementById('post_question').value = postQuestion || '';
  if(postKind === 'text'){
    document.getElementById('post_text').value = (document.getElementById('post_textarea')?.value || '').trim();
  }else if(postKind === 'mcq'){
    const chosen = document.querySelector('input[name="post_mcq"]:checked');
    if(chosen){
      document.getElementById('post_choice_value').value = chosen.value;
      document.getElementById('post_choice_label').value = chosen.getAttribute('data-label') || '';
    }
  }
}

function showLoadingIfLast(){
  if(isLast){
    const overlay = document.getElementById('loadingOverlay');
    const msg = document.getElementById('loadingMsg');
    if (msg) msg.textContent = isGpt
      ? "Generating your reflective journal…"
      : "Finalizing your result…";
    overlay.classList.add('show');
    continueBtn.disabled = true;
  }
}

// ---------- Modal setup (static + guarded close) ----------
let preModal, postModal;

document.addEventListener('DOMContentLoaded', ()=>{
  if(hasPre){
    const preEl = document.getElementById('preModal');
    preModal = new bootstrap.Modal(preEl, { backdrop: 'static', keyboard: false });
    preModal.show();

    // Guard close on X/ESC/backdrop
    preEl.addEventListener('hide.bs.modal', (ev)=>{
      if(!validatePre()){ ev.preventDefault(); }
    });

    document.getElementById('preConfirm')?.addEventListener('click', ()=>{
      if(validatePre()){
        fillHiddenPre();
        preModal.hide();
      }
    });
  }

  if(hasPost){
    const postEl = document.getElementById('postModal');
    postModal = new bootstrap.Modal(postEl, { backdrop: 'static', keyboard: false });

    // Guard close on X/ESC/backdrop
    postEl.addEventListener('hide.bs.modal', (ev)=>{
      if(!validatePost()){ ev.preventDefault(); }
    });

    document.getElementById('postConfirm')?.addEventListener('click', ()=>{
      if(validatePost()){
        fillHiddenPost();
        postModal.hide();
        showLoadingIfLast();
        df.submit();
      }
    });
  }
});

// ---------- Continue button flow ----------
continueBtn.addEventListener('click', ()=>{
  const selected = document.querySelector('input[name="choice"]:checked');
  if(!selected){
    alert('Please select one option.');
    return;
  }

  if(hasPost){
    postModal?.show();
  }else{
    showLoadingIfLast();
    document.getElementById('decisionForm').submit();
  }
});
</script>

{% endblock %}
